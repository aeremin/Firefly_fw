<!DOCTYPE html>
<html>
<body>
<div id="app">
<button onclick="Connect()">Connect</button>
<button onclick="Disconnect()">Disconnect</button>
<button onclick="SetColor(1)">Write 1</button>
<button onclick="SetColor(0)">Write 0</button>
<div>Button value: {{ buttonValue }}</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.6.1/firebase-firestore.js"></script>
<script>
var gDevice = undefined;
var gServer = undefined;

var vm = new Vue({
  el: '#app',
  data: {
    input: '# hello',
    buttonValue: 0,
  }
})


firebase.initializeApp({
  projectId: 'larp-hardware'
});
var db = firebase.firestore();
var doc = db.collection("firefly").doc("aeremin")
doc.onSnapshot(onFirestoreChange);

function Connect() {
  navigator.bluetooth.requestDevice({
    filters: [{ services: ['00001523-1212-efde-1523-785feabcd123'] }],
  })
  .then(device => {
    device.gatt.connect().then(server => {
      gServer = server

      server.getPrimaryService('00001523-1212-efde-1523-785feabcd123')
      .then(service => service.getCharacteristic('00001524-1212-efde-1523-785feabcd123'))
      .then(characteristic => characteristic.startNotifications())
      .then(characteristic => {
        characteristic.addEventListener('characteristicvaluechanged', HandleButtonStateChanged);
        console.log('Notifications have been started.');
      })
      .catch(error => { console.log(error); });
    });
    gDevice = device
  })
  .catch(error => console.log(error));
}

function Disconnect() {
  gDevice.gatt.disconnect();
  gDevice = undefined;
  gServer = undefined;
}

function SetColor(value) {
  doc.set({color: value}, {merge: true});
}

function HandleButtonStateChanged(event) {
  var value = event.target.value.getUint8(0);
  doc.set({buttonValue: value}, {merge: true});
}

function onFirestoreChange(doc) {
  var data = doc.data();
  console.log("Current data: ", data);
  WriteBle(data.color);
  vm.buttonValue = data.buttonValue;
}

function WriteBle(value) {
    if (gServer) {
      gServer.getPrimaryService('00001523-1212-efde-1523-785feabcd123')
        .then(service => service.getCharacteristic('00001525-1212-efde-1523-785feabcd123'))
        .then(characteristic => characteristic.writeValue(Uint8Array.of(value)))
        .catch(error => console.log(error));
    }
}

</script>

</body>
</html>