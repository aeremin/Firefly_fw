<!DOCTYPE html>
<html>
<body>

<button onclick="Connect()">Connect</button>
<button onclick="Disconnect()">Disconnect</button>
<button onclick="Write(1)">Write 1</button>
<button onclick="Write(0)">Write 0</button>
<script src="https://www.gstatic.com/firebasejs/6.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.6.1/firebase-firestore.js"></script>
<script>
var gDevice = undefined;
var gServer = undefined;
var gUnsub = undefined;

firebase.initializeApp({
  projectId: 'larp-hardware'
});
var db = firebase.firestore();
var doc = db.collection("firefly").doc("aeremin")

function Connect() {
  navigator.bluetooth.requestDevice({
    filters: [{ services: ['00001523-1212-efde-1523-785feabcd123'] }],
  })
  .then(device => {
    device.gatt.connect().then(server => {
      gServer = server

      server.getPrimaryService('00001523-1212-efde-1523-785feabcd123')
      .then(service => service.getCharacteristic('00001524-1212-efde-1523-785feabcd123'))
      .then(characteristic => characteristic.startNotifications())
      .then(characteristic => {
        characteristic.addEventListener('characteristicvaluechanged',
                                        handleCharacteristicValueChanged);
        console.log('Notifications have been started.');
      })
      .catch(error => { console.log(error); });


      gUnsub = doc.onSnapshot(function(doc) {
          console.log("Current data: ", doc.data());
          WriteBle(doc.data().color);
      });
    });
    gDevice = device
  })
  .catch(error => console.log(error));
}

function Disconnect() {
  gDevice.gatt.disconnect();
  gDevice = undefined;
  gServer = undefined;
  gUnsub();
  gUnsub = undefined;
}

function Write(value) {
  doc.set({color: value});
}

function WriteBle(value) {
    if (gServer) {
      gServer.getPrimaryService('00001523-1212-efde-1523-785feabcd123')
        .then(service => service.getCharacteristic('00001525-1212-efde-1523-785feabcd123'))
        .then(characteristic => characteristic.writeValue(Uint8Array.of(value)))
        .catch(error => console.log(error));
    }
}


function handleCharacteristicValueChanged(event) {
  var value = event.target.value;
  console.log('Received ' + value.getUint8(0));
}
</script>

</body>
</html>